<html>
  <head>
    <title>热点跟踪</title>
    <style>
      * {
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box
      }
      div {
        font-family: Arial, 'Microsoft YaHei';
      }
      .clearfix {
        overflow:hidden;
        _zoom:1;
      }
      [v-cloak] {
          display: none;
      }
      li {
        list-style-type: none;
      }
      /* weibo */
      .weibo {
        font-size: 14px;
        font-family: Arial, 'Microsoft YaHei';
        max-width: 500px;
        margin-bottom: 10px;
      }
      .weibo:not(.is-forward){
          padding: 5px 5px;
          box-shadow: 0 0 2px rgba(0,0,0,0.2);
          border-radius: 2px;
          background: #FFF;
      }
      .weibo.is-forward {
        font-size: 12px;
        padding-left: 15px;
        padding-top: 5px;
        padding-bottom: 5px;
        margin-left: -5px;
        margin-right: -5px;
        background-color: #F2F2F5;
        margin-bottom: 0;
      }
      .weibo p {
        margin-top: 0;
        margin-bottom: 5px;
      }
      .weibo a {
        color: #333;
        text-decoration: none;
      }
      .weibo a:hover {
        color: #337ab7;
      }
      .weibo:not(.is-forward) .weibo-handle {
        margin: 0 -5px 0 -5px;
      }
      .weibo .weibo-handle ul{
        margin: 0;
        padding: 0;
        width: 100%;
      }
      .weibo.is-forward .weibo-handle ul{
        padding-left: 50%;
      }
      .weibo .weibo-handle li{
        width: 33%;
        display: list-item;
        float: left;
        /*border-left: #d9d9d9 1px solid;*/
        text-align: center;
      }
      /*weibo-follow*/
      .weibo-follow {
        float: left;
        padding: 5px 5px;
        margin: 5px 5px;
        box-shadow: 0 0 2px rgba(0,0,0,0.2);
        background-color: rgb(180, 218, 240);
        border-radius: 2px;
      }
      .weibo-follow .weibo-follow-header {
        margin-top: -5px;
        margin-left: -5px;
        margin-right: -5px;
        margin-bottom: 10px;
        padding: 5px;
        background-color: rgb(147, 197, 226);
        border-radius: 2px;


      }
    </style>
  </head>
  <body id="main_container">
    <wordfollower-control></wordfollower-control>
    <div id="follow_container">
      <weibo-follow key-word="江苏 高考"></weibo-follow>
      <weibo-follow key-word="南京"></weibo-follow>
    </div>
    <script type="text/x-template" id="wordfollower_control_temmplate">
      <div class="wordfollow-control">
          <table>
            <thead>
              <th>关键词</th>
              <th>运行状态</th>
              <th>最近一次爬取</th>
              <th>爬取间隔</th>
            </thead>
            <tbody>
              <tr v-for="wf in wordfollowers">
                <td>{{ wf.word }}</td>
                <td>{{ wf.running }}</td>
                <td>{{ wf.time_text }}</td>
                <td>{{ wf.interval }}</td>
              </tr>
            </tbody>
          </table>
      </div>
    </script>
    <script type="text/x-template" id="weibo_follow_temmplate">
      <div class='weibo-follow'>
        <div class="weibo-follow-header"><b>{{ keyWord }}</b></div>
        <div>
          <weibo v-for="tweet in tweets" v-bind:tweetp="tweet" v-bind:is_forward="false"></weibo>
        </div>
      </div>
    </script>
    <script type="text/x-template" id="weibo_template">
      <div class="weibo" v-bind:class="{ 'is-forward': is_forward }">
        <b><a href="http://weibo.com/u/{{ tweet.uid }}">{{ tweet.nickname }}</a></b>
        <p>
          <a href="http://weibo.com/{{ tweet.uid}}/{{ tweet.mid }}">{{ tweet.time }}</a>
          <small v-if="tweet.device"> By {{ tweet.device }}</small>
          <small v-if="tweet.location"> @ {{ tweet.location }}</small>
          </p>
        <p>{{ tweet.text }}</p>
        <weibo v-if="tweet.forward_tweet" v-bind:tweetp="tweet.forward_tweet" v-bind:is_forward="true"></weibo>
        <div class="weibo-handle">
          <ul class="clearfix">
            <li>转发 {{ tweet.share }}</li>
            <li>评论 {{ tweet.comment }}</li>
            <li>赞 {{ tweet.like }}</li>
          </ul>
        </div>
      </div>
    </script>
    <script src="/static/js/vue.js"></script>
    <script src="/static/js/vue-router.js"></script>
    <script src="/static/js/jquery-2.2.3.min.js"></script>
    <script>
    Date.prototype.Format = function (fmt) { //author: meizz
      var o = {
        "M+": this.getMonth() + 1, //月份
        "d+": this.getDate(), //日
        "h+": this.getHours(), //小时
        "m+": this.getMinutes(), //分
        "s+": this.getSeconds(), //秒
        "q+": Math.floor((this.getMonth() + 3) / 3), //季度
        "S": this.getMilliseconds() //毫秒
      };
      if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      for (var k in o)
        if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
      return fmt;
    }
    </script>
    <script>
var WordFollowerControl = Vue.extend({
  template: '#wordfollower_control_temmplate',
  data: function(){
    return {
      wordfollowers_raw: []
    }
  },
  computed: {
    wordfollowers:function(){
      var wordfollowers = [];
      for (var i = 0; i < this.wordfollowers_raw.length; i++){
        var t = this.wordfollowers_raw[i];
        wordfollowers.push({
          word: t.word,
          running: t.running,
          time_text: new Date(t.newest_timestamp).Format("yyyy-MM-dd hh:mm:ss"),
          interval: t.interval
        });
      }
      return wordfollowers;
    }
  },
  activate: function (done) {
    var self = this;
    $.getJSON('/api/wordfollow/' , function(data){
      self.wordfollowers_raw=data;
      done();
    });
  }
});
Vue.component('wordfollower-control', WordFollowerControl);

var WeiboFollow = Vue.extend({
  template: '#weibo_follow_temmplate',
  props:{
    'keyWord': String
  },
  data:function(){
      return {
        tweets: []
      };
  },
  activate: function (done) {
    var self = this;
    $.getJSON('/api/wordupdate/?word=' + self.keyWord, function(data){
      self.tweets=data;
      done();
    });
  }
});
Vue.component('weibo-follow', WeiboFollow);

Vue.component('weibo', {
  template: '#weibo_template',
  props: ['tweetp', 'is_forward'],
  computed: {
    tweet: function() {
      var tp = this.tweetp;
      return {
        'uid': tp.uid,
        'mid': tp.mid,
        'nickname': tp.nickname,
        'text': tp.text,
        'time': new Date(tp.timestamp).Format("yyyy-MM-dd hh:mm:ss"),
        'device': tp.device,
        'share': tp.share,
        'comment': tp.comment,
        'like': tp.like,
        'forward_tweet': tp.forward_tweet
      }
    }
  }
});
var vm = new Vue({
  el: "#main_container"
});
    </script>
  </body>
</html>
